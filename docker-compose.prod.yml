version: '3.8'

services:
  # 1. Django Web Application (Gunicorn)
  web:
    build: .
    # [핵심] runserver 대신 배포용 WSGI 서버인 Gunicorn 사용
    # --bind 0.0.0.0:8000 : 컨테이너 내부 8000번 포트로 실행
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000
    volumes:
      # 코드 변경 사항은 더 이상 실시간 반영 안 함 (보안 및 안정성)
      # 정적 파일과 미디어 파일만 볼륨으로 공유하여 Nginx가 접근 가능하게 함
      - static_volume:/app/static
      - media_volume:/app/media
    expose:
      - 8000 # 호스트에는 노출하지 않고, 같은 도커 네트워크(Nginx)에만 8000번 노출
    env_file:
      - .env
    depends_on:
      - db
      - redis
    restart: always # 서버가 죽거나 재부팅되면 자동 실행

  # 2. Celery Worker (비동기 작업)
  worker:
    build: .
    command: celery -A config worker -l info
    volumes:
      - .:/app # 워커는 코드 참조 필요 (로그 저장 등을 위해 유지 가능)
    env_file:
      - .env
    depends_on:
      - db
      - redis
    restart: always

  # 3. Nginx (리버스 프록시 & 정적 파일 서빙)
  nginx:
    image: nginx:latest
    ports:
      - "80:80" # 외부(AWS)의 80번 포트 요청을 받음
    volumes:
      # 작성해야 할 nginx 설정 파일 연결
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      # Django가 모아둔(collectstatic) 정적 파일을 Nginx가 읽어서 제공
      - static_volume:/app/static
      - media_volume:/app/media
    depends_on:
      - web # Django가 켜진 뒤에 실행
    restart: always

  # 4. Database (PostgreSQL + pgvector)
  db:
    image: pgvector/pgvector:pg16
    volumes:
      - postgres_data:/var/lib/postgresql/data
    env_file:
      - .env
    restart: always

  # 5. Redis (브로커)
  redis:
    image: redis:alpine
    restart: always

# 볼륨 정의 (데이터 영구 저장 및 컨테이너 간 공유)
volumes:
  postgres_data:
  static_volume:
  media_volume: