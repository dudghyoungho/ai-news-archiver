{% extends 'links/base.html' %}
{% block content %}
<div class="container mx-auto px-4 py-8">
  <!-- í—¤ë” -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">ğŸ§  What I've Learned</h1>
      <p class="text-gray-500">ë‚˜ì˜ ì§€ì‹ ìŠµë“ í˜„í™©ì„ ë¶„ì„í•©ë‹ˆë‹¤.</p>
    </div>

    <div class="flex items-center gap-3">
      <!-- âœ… ì¸ë±ìŠ¤ë¡œ ëŒì•„ê°€ê¸° -->
      <a href="/"
         class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition font-bold">
        ê¸°ì‚¬ ì½ìœ¼ëŸ¬ ê°€ê¸°
      </a>

      <!-- âœ… ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼: ì´ ë²„íŠ¼ ëˆŒëŸ¬ì•¼ë§Œ stats_contentë¥¼ ë‹¤ì‹œ í˜¸ì¶œ -->
      <button
        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition font-bold"
        hx-get="{% url 'stats_content' %}"
        hx-target="#stats-container"
        hx-swap="innerHTML"
      >
        ìƒˆë¡œê³ ì¹¨
      </button>
    </div>
  </div>

  <!-- âœ… ìë™ ë¡œë”© ì—†ìŒ: ì„œë²„ê°€ snapshot/includeë¡œ ë‚´ë ¤ì¤€ ë‚´ìš©ë§Œ í‘œì‹œ -->
  <div id="stats-container">
    {% include 'links/partials/stats_content.html' %}
  </div>
</div>

<!-- Chart.jsëŠ” base.htmlì— ì´ë¯¸ ìˆìœ¼ë©´ ì¤‘ë³µ ë¡œë“œí•˜ì§€ ë§ˆì„¸ìš” -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- âœ… HTMXë¡œ stats_contentê°€ êµì²´ë  ë•Œë„ ì°¨íŠ¸ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ê¸° ìœ„í•œ í›… -->
<script>
  (function() {
    // Chart ì¸ìŠ¤í„´ìŠ¤ ë³´ê´€
    window.__statsCharts = window.__statsCharts || { category: null, tag: null, trend: null };

    function safeParseJSON(value) {
      try { return JSON.parse(value); } catch(e) { return []; }
    }

    function destroyIfExists(chartRef) {
      if (chartRef && typeof chartRef.destroy === "function") {
        chartRef.destroy();
      }
      return null;
    }

    function renderStatsCharts() {
      const root = document.getElementById('stats-root');
      if (!root) return;

      // âœ… ë°ì´í„°ëŠ” stats_content.htmlì—ì„œ data-* ë¡œ ë‚´ë ¤ì˜´
      const catLabels = safeParseJSON(root.dataset.catLabels || "[]");
      const catData   = safeParseJSON(root.dataset.catData || "[]");
      const tagLabels = safeParseJSON(root.dataset.tagLabels || "[]");
      const tagData   = safeParseJSON(root.dataset.tagData || "[]");
      const trendLabels = safeParseJSON(root.dataset.trendLabels || "[]");
      const trendData   = safeParseJSON(root.dataset.trendData || "[]");

      // ìº”ë²„ìŠ¤ ì¡´ì¬ í™•ì¸
      const catCanvas = document.getElementById('categoryChart');
      const tagCanvas = document.getElementById('tagChart');
      const trendCanvas = document.getElementById('trendChart');

      // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°(ì¤‘ë³µ ë Œë” ë°©ì§€)
      window.__statsCharts.category = destroyIfExists(window.__statsCharts.category);
      window.__statsCharts.tag = destroyIfExists(window.__statsCharts.tag);
      window.__statsCharts.trend = destroyIfExists(window.__statsCharts.trend);

      // ë°ì´í„° ì—†ìœ¼ë©´ ë Œë” ìŠ¤í‚µ
      if (!catCanvas || !tagCanvas || !trendCanvas) return;
      if (!catLabels.length && !tagLabels.length && !trendLabels.length) return;

      // 1) Radar
      if (catLabels.length && catData.length) {
        window.__statsCharts.category = new Chart(catCanvas.getContext('2d'), {
          type: 'radar',
          data: {
            labels: catLabels,
            datasets: [{
              label: 'ì ìˆ˜',
              data: catData,
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              borderColor: 'rgb(59, 130, 246)',
              pointBackgroundColor: 'rgb(59, 130, 246)',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                beginAtZero: true,
                suggestedMax: 5,
                ticks: { stepSize: 1, display: false }
              }
            },
            plugins: { legend: { display: false } }
          }
        });
      }

      // 2) Bar (horizontal)
      if (tagLabels.length && tagData.length) {
        window.__statsCharts.tag = new Chart(tagCanvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: tagLabels,
            datasets: [{
              label: 'ë¹ˆë„',
              data: tagData,
              backgroundColor: [
                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'
              ],
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { grid: { display: false } } }
          }
        });
      }

      // 3) Line
      if (trendLabels.length && trendData.length) {
        window.__statsCharts.trend = new Chart(trendCanvas.getContext('2d'), {
          type: 'line',
          data: {
            labels: trendLabels,
            datasets: [{
              label: 'ì½ì€ ê¸°ì‚¬',
              data: trendData,
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, ticks: { stepSize: 1 } },
              x: { grid: { display: false } }
            },
            plugins: { legend: { display: false } }
          }
        });
      }
    }

    // âœ… ìµœì´ˆ í˜ì´ì§€ ë¡œë“œ ì‹œ 1íšŒ ë Œë”
    document.addEventListener('DOMContentLoaded', renderStatsCharts);

    // âœ… HTMXë¡œ stats-containerê°€ ê°±ì‹ ëœ ë’¤ì—ë„ ë Œë”
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      if (evt.target && evt.target.id === 'stats-container') {
        renderStatsCharts();
      }
    });
  })();
</script>
{% endblock %}