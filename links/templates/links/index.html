{% extends 'links/base.html' %}
{% block content %}

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

  <!-- ================= ì™¼ìª½ ì˜ì—­ ================= -->
  <div class="md:col-span-2 space-y-4">

    <!-- ğŸ”¹ ë‰´ìŠ¤ ì¶”ê°€ (ì»´íŒ©íŠ¸) -->
    <div class="bg-white p-4 rounded-lg shadow-md">
      <h2 class="text-lg font-bold mb-3 text-gray-800">ğŸ“° ìƒˆë¡œìš´ ë‰´ìŠ¤ ì¶”ê°€</h2>

      <form
        hx-post="{% url 'htmx_link_create' %}"
        hx-trigger="submit"
        hx-target="#link-list"
        hx-swap="outerHTML"
        id="link-form"
        class="flex gap-2"
      >
        {% csrf_token %}
        <input
          type="url"
          name="url"
          placeholder="ë„¤ì´ë²„ ë‰´ìŠ¤ URL ì…ë ¥"
          required
          class="flex-1 p-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm"
        />
        <button
          type="submit"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-bold transition text-sm"
        >
          ì¶”ê°€
        </button>
      </form>

      <p class="text-xs text-gray-400 mt-1">
        ì…ë ¥í•˜ë©´ AIê°€ ìë™ ìš”ì•½í•©ë‹ˆë‹¤ (ì•½ 5~10ì´ˆ)
      </p>
    </div>

    <!-- âš¡ ë¹ ë¥¸ ì•¡ì…˜ íŒ¨ë„ -->
    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-lg border border-indigo-100">
      <h3 class="text-sm font-bold text-indigo-700 mb-3">âš¡ ë¹ ë¥¸ ì¶”ì²œ</h3>

      <div class="flex flex-wrap gap-2">
        <!-- ê´€ì‹¬ì‚¬ ê¸°ë°˜ ì¶”ì²œ -->
        <form hx-post="{% url 'htmx_recommend_interest' %}"
              hx-target="#link-list"
              hx-swap="outerHTML"
              hx-on::after-request="
              document.getElementById('recommend-indicator').classList.remove('hidden');
              setTimeout(() => document.getElementById('recommend-indicator').classList.add('hidden'), 5000);
              setTimeout(() => htmx.ajax('GET','/',{target:'#link-list',select:'#link-list',swap:'outerHTML'}), 5000);
            ">
          {% csrf_token %}
          <button type="submit"
                  class="bg-purple-600 text-white px-4 py-2 rounded-md text-sm hover:bg-purple-700 transition">
            ğŸ¯ ê´€ì‹¬ì‚¬ ì¶”ì²œ
          </button>
        </form>

        <form hx-post="{% url 'htmx_recommend_explore' %}"
                hx-target="#link-list"
                hx-swap="outerHTML"
                hx-on::after-request="
                document.getElementById('recommend-indicator').classList.remove('hidden');
                setTimeout(() => document.getElementById('recommend-indicator').classList.add('hidden'), 5000);
                setTimeout(() => htmx.ajax('GET','/',{target:'#link-list',select:'#link-list',swap:'outerHTML'}), 5000);
              ">
            {% csrf_token %}
            <button type="submit"
                    class="bg-emerald-600 text-white px-4 py-2 rounded-md text-sm hover:bg-emerald-700 transition">
              ğŸŒ± íƒí—˜ ì¶”ì²œ
            </button>
          </form>
      </div>

      <div id="recommend-indicator" class="hidden mt-3 text-xs text-gray-600">
        ì¶”ì²œí•  ê¸°ì‚¬ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
      </div>
    
      <p class="text-xs text-gray-500 mt-2">
        í•˜ë£¨ì— 4ë²ˆ, 6ì‹œê°„ë§ˆë‹¤ 1ë²ˆ ì”© ìë™ìœ¼ë¡œ ê¸°ì‚¬ê°€ ì¶”ì²œë©ë‹ˆë‹¤.
      </p>
    </div>
    
    <style>
      /* í¼ì´ ìš”ì²­ ì¤‘ì´ë©´(HTMXê°€ htmx-request ë¶€ì—¬) ë²„íŠ¼ì„ ë¡œë”© ìƒíƒœë¡œ */
      form.htmx-request .recommend-btn { opacity: .7; pointer-events: none; }
      form.htmx-request .recommend-btn .label { content: ""; }
      form.htmx-request .recommend-btn .spinner { display: inline-block !important; }
      form.htmx-request .recommend-btn .label::after { content: " ì²˜ë¦¬ ì¤‘â€¦"; }
    </style>

  </div>

  <!-- ================= ì˜¤ë¥¸ìª½ ì˜ì—­ ================= -->
  <div class="bg-white p-5 rounded-lg shadow-md flex flex-col items-center justify-between">
    <h2 class="text-lg font-bold mb-2 text-gray-700">ğŸ“Š ë‚˜ì˜ ê´€ì‹¬ì‚¬ TOP 5</h2>

    <div class="w-full h-48 relative">
      <canvas id="tagChart"></canvas>
    </div>

    <a href="{% url 'stats_page' %}" 
       class="text-sm text-indigo-600 hover:underline mt-2 font-medium">
      ìƒì„¸ ë¶„ì„ ë³´ê¸° â†’
    </a>
  </div>

</div>

<!-- ================= ë‰´ìŠ¤ ë¦¬ìŠ¤íŠ¸ ================= -->
{% include 'links/partials/link_list.html' %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // í¼ ì œì¶œ í›„ input ë¹„ìš°ê¸°
  document.body.addEventListener('htmx:afterRequest', function(evt) {
      if(evt.detail.elt.id === 'link-form' && evt.detail.successful) {
          document.querySelector('input[name="url"]').value = '';
      }
  });

  // ì°¨íŠ¸ ë Œë”
  const ctx = document.getElementById('tagChart').getContext('2d');
  const labels = {{ chart_labels|safe }};
  const data = {{ chart_data|safe }};

  if (labels.length > 0) {
      new Chart(ctx, {
          type: 'doughnut',
          data: {
              labels: labels,
              datasets: [{
                  data: data,
                  backgroundColor: [
                      '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'
                  ],
                  borderWidth: 0
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'bottom',
                      labels: { boxWidth: 10, font: { size: 10 } }
                  }
              }
          }
      });
  }
</script>

{% endblock %}